<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <!--
      File: arrivals.html
      
      Programmers:
      Daniel Brook, UMass Lowell student (daniel_brook@student.uml.edu)
      Austin Veino, UMass Lowell Student (austin_veino@student.uml.edu)
      Jivani Cassar, UMass Lowell Student (jivani_cassar@student.uml.edu)
      
      Copyright (c) 2013 by Daniel Brook. All rights reserved. This page may
      be used for any purpose so long as credit to the author is given.
      
      Page updated by Daniel Brook on 2013-03-13 at 4:50 PM
      
      Description:
      This page will serve as the interface users will see after selecting a 
      station on the main page. The viewing options will be customizable in
      the next iteration (the beta version). For now, this page will display
      the data sorted by arrival time, more or less an exact replica (but 
      human-readable) of the underlying arrivals data structure. The output is
      a little too verbose for public consumption, but this is necessary as 
      the data's behavior continues to be examined.
      
      All data is provided by the Massachusetts Bay Transportation Authority
      (MBTA) and the Massachusetts Department of Transportation (MassDOT). The
      arrival data is experimental and provided as-is, without any guarantee
      of its accuracy. Mass TRAC, nor its developers are affiliated with 
      MassDOT or the MBTA.
    -->

    <title>Mass TRAC - Station Arrival Information Page</title>

    <!--
      The main style sheet for this page is arrivals.css, but to keep a 
      consistent color scheme for the lines that use the MBTA's CSS colors,
      mbta_colors.css as a separate entity.
    -->
    <link rel="stylesheet" type="text/css" href="css/arrivals.css">
    <link rel="stylesheet" type="text/css" href="css/black-tie/jquery-ui-1.10.1.custom.css">
    <link rel="stylesheet" type="text/css" href="css/mbta_colors.css">
    
    <!--
      Populating this page requires a healthy amount of JavaScript. First,
      the URL parameter(s) need to be isolated so the masstrac functions can
      properly do their job. 
      
      There is jQuery used throughout much of the page as well, so jQuery has
      to be included early on as well. 
      
      The structures.js contains initialization and details about the data
      structures the masstrac functions will use and/or populate while running.
      
      The stations.js file contains the list of all stations, what lines stop
      at each, what bus connections are available, and the lat/lon.
      
      The green.js file contains details about Green Line operations which is
      needed to overcome the lack of real-time data on the light rail side.
      
      The datagetter.js does much of the heavy lifting of asking for new data,
      sorting it (if desired), and looking up of alerts from the T's RSS feed.
      
      Finally, the ui.js file does much of the work of looking through what the
      masstrac functions have populated into the array[s] and displays that
      information for the user.
      
      And for real finally, the canvops.js file contains all the code for 
      plotting real-time station locations onto HTML5 canvas objects!
    -->
    <script src="lib/jhmformutils.js" type="text/javascript"></script>
    
    <script src="lib/jquery-1.9.1.min.js" type="text/javascript"></script>
    <script src="lib/jquery-ui-1.10.1.custom.min.js" type="text/javascript"></script>
    
    <script src="lib/structures.js" type="text/javascript"></script>
    <script src="lib/stations.js" type="text/javascript"></script>
    <script src="lib/green.js" type="text/javascript"></script>
    <script src="lib/datagetter.js" type="text/javascript"></script>
    <script src="lib/ui.js" type="text/javascript"></script>
    <script src="lib/canvops.js" type="text/javascript"></script>
    
    <!--
      When ready, start requesting the arrival data.
    -->
    <script>
      function reloadData()
      {
        // Give visual feedback that a refresh is happening
        $("#refreshDiv").html("Retrieving New Data");
        
        /*
         * Before doing anything else, empty the masstrac.arrivals array
         * otherwise there will be duplicate entries (which are confusing)
         */
        masstrac.dumpData();
        
        /*
         * Request new arrival data (for the predictable lines)
         */
        for (var service = 0; service < staObj.svcs.length; service++) {
          /*
           * Try and get the arrivals for the station on [each] applicable line.
           * If an error occurs, this just stops and leaves a warning icon.
           */
          if (masstrac.getArrivals( staObj.name, staObj.svcs[service] ) == false) {

            $("#refreshDiv").html(
            "<img src='img/hard_error.png' width='42' height='42'" + 
              " title='Data Acquisition Error, try refreshing the page again.'>" +
              " Arrival Time Error"
            );
            
            return;
          }
          
          /*
           * Show Green Line headways if applicable
           */
          if (staObj.svcs[service] == "green")
            displayGreenLine();
        }
        
        /*
         * Request the arrival data to be rendered
         */
        displayArrivals( "time" );
        
        /*
         * Now run the alert grabber. This will append to masstrac.alerts[] for
         * each relevant (to the station AND each line servicing that station)
         * alert. Any pertinent alerts will display the alert icon, as well as
         * make the alerts div displayable.
         */
        if (masstrac.getStationAlerts( staObj ) == false) {
            $("#refreshDiv").html(
            "<img src='img/hard_error.png' width='42' height='42'" + 
              " title='Data Acquisition Error, try refreshing the page again.'>" +
              " Alert Feed Error"
            );
            return;
        }
        
        /*
         * Now see if the alert data needs to even be shown
         */
        if (masstrac.alerts.length > 0) {
          displayAlerts();
          
          // Display the alert triangle icon
          $("#iconAlert").show();
          
          // Also enable the alerts tab forcing it to display
          $("#suppContent").tabs("enable", 0);
          
        } else {
          // Just gray out or hide the alert triangle.
          $("#iconAlert").hide();
          
          // The 1st tab is the alerts one. We disable it because we've set the
          // associated CSS to NOT DISPLAY disabled things.
          $("#suppContent").tabs("disable", 0);
        }

        /*
         * Plot the trains with available lat/lon information, but first we 
         * need the base map of the lines themselves. Additionally, erasing the
         * previous content of the canvas will prevent any strange artifacts.
         */
        for (var line = 0; line < staObj.svcs.length; line++) {
          switch (staObj.svcs[line]) {
            case "orange":
              canvops.clearplot("orange");
              canvops.basemap("orange");
              canvops.plotTrips("orange");
              break;
            case "red":
              canvops.clearplot("red");
              canvops.basemap("red");
              canvops.plotTrips("red");
              break;
            case "blue":
              canvops.clearplot("blue");
              canvops.basemap("blue");
              canvops.plotTrips("blue");
              break;
            default:
              break;
          }
        }

        // Put the refresh div back with the new time
        // Apparently constructing time stamps is a total pain, but this
        // the most likely to work across browsers.
        var now = new Date();
        
        var updTime = now.getHours();
        if (now.getMinutes() < 10) updTime += ":" + 0 + now.getMinutes();
        else                       updTime += ":" + now.getMinutes();
        
        if (now.getSeconds() < 10) updTime += ":" + 0 + now.getSeconds();
        else                       updTime += ":" + now.getSeconds();
        
        if (auto_update_flag == "on") {
          $("#refreshDiv").html( "Updated: " + updTime );
        } else {
          $("#refreshDiv").html(
          "<img src='img/view-refresh.png' width='42' height='42' " + 
            "title='Refresh the data manually'>" + " Updated: " + updTime );
        }
        
      }  // End of GLOBAL NAMESPACE function reloadData()
    </script>
    <script>
      /*
       * The auto-update function should be run with a true argument to
       * enable the clock and have the page try and update automatically.
       * To disable, just send it false.
       * 
       * http://www.w3schools.com/js/js_timing.asp
       */
      
      // Instantiate the auto_active variable first
      var auto_active;
      
      function autoUpdate( mode ) {
        if (mode) {
          /*
           * Start the timer if requested, but also update the widgets to
           * reflect that context of automatic updates (i.e. no manual refresh)
           * 60000 = 60 seconds (1 minute)
           */
          auto_active = window.setInterval( reloadData , 30000 );
          $("#refreshDiv").html("Automatic Refresh Enabled");
          $("#autoRefToggle").html("<img src='img/auto-refresh.png'" + 
            "width='42' height='42' title='Turn Automatic Refresh Off'>");
          
          // Disassociate the click handler if auto refresh is on
          $("#refreshDiv").unbind( "click" );
                  
        } else {
          window.clearInterval( auto_active );
          $("#refreshDiv").html("<img id='refIcon' src='img/view-refresh.png'" +
            "width='42' height='42' title='Refresh the data manually'>" + 
            " Click to Refresh");
          $("#autoRefToggle").html("<img src='img/auto-refresh-off.png'" + 
            "width='42' height='42' title='Turn Automatic Refresh On'>");
          
          // Assign the reload data function to the 
          // click-handler on the refresh icon.
          $("#refreshDiv").click( function () {
            reloadData();
          });
        }
      }  // End of GLOBAL NAMESPACE function autoUpdate( bool )
      </script>
      <script>
      /*
       * The ready function (from jQuery) that will load on startup.
       */
      $(document).ready( function () {
        
        // Get the name of the station requested and send it to the updater.
        // (But first get rid of the %20 where there are spaces in the names).
        // Thanks to:
        // http://stackoverflow.com/questions/3794919/replace-all-spaces-in-a-string-with
        
        var stop_name = (getParameter( "name" )).split("%20").join(" ");
        
        // Should automatic refreshing be enabled?
        auto_update_flag = getParameter( "autoRef" );
        
        if (auto_update_flag == "on")
          autoUpdate( true );
        else
          autoUpdate( false );
        
        /*
         * Find where the station is in masstrac.stations and make shortcut
         * This will be global to make life a little easier.
         */
        staObj = masstrac.lookupStation( stop_name );
        
        if (staObj == false) {
          $("#refreshDiv").html(
          "<img src='img/hard_error.png' width='42' height='42'" + 
            " title='Data Acquisition Error, try refreshing the page.'>" +
            " Invalid Station Name"
          );
          return;
        }
        
        /*
         * Make the header area with the station name and line selectors
         */
        makeTitle( staObj );
        
        // The hover / click event techniques come from here:
        // http://creativeindividual.co.uk/2011/02/create-a-pop-up-div-in-jquery/
        // Note that there is some requisite CSS happening here, too
        
        // This is needed to KEEP the window hovered if the mouse goes into it
        $("#disclaimShow").hover( function (event) { $("#disclaimer").toggle(); });
        $("#disclaimer").hover( function (event) { $("#disclaimer").toggle(); });
        
        // Don't show alert icon by default
        $("#iconAlert").hide();
        
        // Force the resize handler to fire right at load time
        $(window).resize();
        
        // Assign the toggle-able automatic-refresh to the assigned icon
        $("#autoRefToggle").click( function () {
          if (auto_update_flag == "on") {
            autoUpdate( false );
            auto_update_flag = "off";
          } else {
            autoUpdate( true );
            auto_update_flag = "on";
          }
        });
        
        /*
         * Try to tab-ify the supplemental content area.
         * Hide all the subway live plotting areas first.
         */
        $("#suppContent").tabs({event: "mouseover", "disabled": [1, 2, 3]});
        
        /*
         * Show the bus connections (if any)
         */
        if (staObj.bus.length > 0) {
          displayBus( staObj );
          $("#suppContent").tabs("enable", 4);
        } else {
          $("#suppContent").tabs("disable", 4);
        }
        
        for (var line = 0; line < staObj.svcs.length; line++) {
          switch (staObj.svcs[line]) {
            case "orange":
              $("#suppContent").tabs("enable", 2);
              break;
            case "red":
              $("#suppContent").tabs("enable", 1);
              break;
            case "blue":
              $("#suppContent").tabs("enable", 3);
              break;
            default:
              break;
          }
        }

        
        // When the page loads, do the data request.
        reloadData();
      });  // End of jQuery document/ready function
      
      /*
       * The Resize Event Handler will make sure that the content still displays
       * as we intended when the user tries to make the window shorter / taller.
       * Set the height of the arrivals display based on the remaining room
       * on the screen (after subtracting height of toolbar and footer), this
       * should optimize the viewing area nicely.
       * 
       * This idea was based off of code found at:
       * http://stackoverflow.com/questions/1443465/jquery-dynamic-div-height
       */
      $(window).resize( function () {
        var newHeight = $(window).height() - ($("#toolbar").height() + $("#nameArea").height() + 40);
        $("#arrivalsArea").css({'height': newHeight + "px"
        });
        $("#suppContent").css({'height': newHeight - 3 + "px"});
      });
    </script>
  </head>

  <body>
    <!--
      The body will be relatively simple without any data loaded into it. This
      page is generated dynamically, so much of the structure is built after 
      the data requests are made.
    -->
    
    <!--
      First set up the heading / title bar area that will house some controls:
       - Title bar with Mass TRAC logo / name on the left
       - Manual refresh button w/ Time of last refresh next to it
       - On the right, have a series of status icons:
          - Alerts exist indicator icon
          - Automatic refresh mode indicator
       - And finally a settings button
    
      A special thanks goes out to the Tango Desktop Project, for the free /
      open icon set that we've used in this site's interface.
    -->
    <div id="toolbar">
      <div>
        <img src="img/logos/MTlogo1.png" width="235" height="40">
      </div>
        <div id="refreshDiv"></div>
      
      <!-- These are in their own DIV so they'll group together and
           be arranged as said group, preventing a weird "scattered" look -->
      <div>
        <div id="iconAlert">
          <img src="img/alert.png" width="42" height="42"
               title="Alerts / Advisories are impacting service">
        </div>
        <div id="autoRefToggle"></div>
        <div id="disclaimShow">
          <img src="img/helpabout.png" width="42" height="42">
        </div>
        <div>
          <img src="img/preferences-system.png" width="42" height="42"
               title="Open the settings dialog">
        </div>
      </div>
    </div>
    <br />    <!-- This seems to be needed otherwise the H1 tag gets
                   assigned to the content bar above. Weird. -->
    
    <!--
      Set up some divs that will eventually hold arrival data.
    -->
    <div id="dynContentArea">
      <div id="nameArea"></div>

      <!-- The arrivals are all grouped together because they need to scroll -->
      <div id="arrivalsArea">
        <div id="predictArea"></div>
        <div id="greenArea"></div>
      </div>
      
      <!-- 
      This supplemental area will be a big tabs widget to show either:
        - Bus Connections
        - Service Alerts (default active if alerts present)
        - Real-Time Position Coordinates
        - If nothing pertinent can be displayed, then ????????
      -->
      <div id="suppContent">
        <ul>
          <li><a href="#alertsArea">Service Alerts</a></li>
          <li><a href="#liveRed">Red Line</a></li>
          <li><a href="#liveOrange">Orange Line</a></li>
          <li><a href="#liveBlue">Blue Line</a></li>
          <li><a href="#busArea">Bus Connections</a></li>
        </ul>
        <div id="alertsArea"></div>
        <div id="liveRed">
          <p>Last Known Red Line Train Positions</p>
          <canvas id="redPlot" width="475" height="475">
            Sorry, you're browser doesn't support HTML5's canvas widget.
            If it did, you'd be seeing a pretty sweet map of the Red Line's
            current train positions. 
          </canvas>
        </div>
        <div id="liveOrange">
          <p>Last Known Orange Line Train Positions</p>
          <canvas id="orangePlot" width="475" height="475">
            Sorry, you're browser doesn't support HTML5's canvas widget.
            If it did, you'd be gazing upon the locations of the operating
            Orange Line trains.
          </canvas>
        </div>
        <div id="liveBlue">
          <p>Last Known Blue Line Train Positions</p>
          <canvas id="bluePlot" width="475" height="475">
            Sorry, you're browser doesn't support HTML5's canvas widget.
            If it did, there would be a map of the Blue Line and the positions
            of each operating train would be shown here instead.
        </canvas>
        </div>
        <div id="busArea"></div>
      </div>
    </div>

    <div id="disclaimer">
      <p>
        All data is provided by MassDOT and the Massachusetts
        Bay Transportation Authority (MBTA). The arrival predictions are 
        based on experimental data and are offered "as-is" without any 
        guarantee of accuracy.
      </p>
    </div>
    
  </body>
</html>
